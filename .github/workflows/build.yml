name: Build TWRP for CMF1

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: [self-hosted, twrp]

    steps:
    - name: Checkout the code
      uses: actions/checkout@v3

    - name: Set up JDK 8
      uses: actions/setup-java@v2
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Set Git user info
      run: |
        git config --global user.name "Null Byte"
        git config --global user.email "andrexyt@proton.me"

    - name: Install dependencies
      run: |
        echo "root" | sudo -S -u actions-runner apt-get update
        echo "root" | sudo -S -u actions-runner apt-get install -y \
          repo \
          git \
          g++-multilib \
          lib32z1-dev \
          libncurses5-dev \
          libssl-dev \
          libxml2-utils \
          bison \
          build-essential \
          squashfs-tools \
          zip \
          libncurses-dev \
          zlib1g-dev \
          gcc-multilib \
          g++-multilib \
          make \
          python3 \
          python3-pip \
          curl \
          wget \
          bc \
          jq

    - name: Clean up disk space
      run: |
        echo "root" | sudo -S -u actions-runner rm -rf /usr/share/dotnet
        echo "root" | sudo -S -u actions-runner rm -rf /usr/local/lib/android
        echo "root" | sudo -S -u actions-runner rm -rf /opt/ghc
        echo "root" | sudo -S -u actions-runner rm -rf /usr/local/share/boost
        echo "root" | sudo -S -u actions-runner rm -rf "$AGENT_TOOLSDIRECTORY"
        echo "root" | sudo -S -u actions-runner apt-get clean
        df -h

    - name: Set up large swap memory (16GB)
      run: |
        echo "root" | sudo -S -u actions-runner swapoff -a
        echo "root" | sudo -S -u actions-runner rm -f /swapfile
        echo "root" | sudo -S -u actions-runner dd if=/dev/zero of=/swapfile bs=1M count=16384
        echo "root" | sudo -S -u actions-runner chmod 600 /swapfile
        echo "root" | sudo -S -u actions-runner mkswap /swapfile
        echo "root" | sudo -S -u actions-runner swapon /swapfile
        echo "root" | sudo -S -u actions-runner swapon --show
        free -h

    - name: Sync the repo
      run: |
        repo init -u https://android.googlesource.com/platform/manifest
        repo sync -j$(nproc --all)

    - name: Set up the build environment
      run: |
        . build/envsetup.sh
        lunch Tetris-userdebug

    - name: Build TWRP
      run: |
        make recoveryimage -j$(nproc --all)

    - name: Export the TWRP artifact
      uses: actions/upload-artifact@v3
      with:
        name: twrp-recovery
        path: out/target/product/*/recovery.img
